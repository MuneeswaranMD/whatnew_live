{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Admin Wallet Dashboard{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007cba;
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #007cba;
        margin: 0;
    }
    
    .stat-description {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    .charts-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
    }
    
    .transactions-table {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transactions-table h3 {
        margin: 0 0 20px 0;
        color: #333;
    }
    
    .transaction-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }
    
    .transaction-info {
        flex: 1;
    }
    
    .transaction-type {
        font-weight: bold;
        color: #333;
        font-size: 14px;
    }
    
    .transaction-desc {
        color: #666;
        font-size: 12px;
        margin-top: 2px;
    }
    
    .transaction-amount {
        font-weight: bold;
        color: #28a745;
        font-size: 16px;
    }
    
    .transaction-date {
        color: #999;
        font-size: 11px;
        text-align: right;
    }
    
    .error {
        color: #dc3545;
        padding: 10px;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .filter-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-group label {
        font-size: 12px;
        color: #666;
        font-weight: bold;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-primary {
        background: #007cba;
        color: white;
    }
    
    .btn-primary:hover {
        background: #005a87;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Admin Wallet Dashboard</h1>
    
    <div id="error-container"></div>
    <div id="loading" class="loading">Loading dashboard data...</div>
    
    <div id="dashboard-content" style="display: none;">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <p class="stat-value" id="total-revenue">₹0</p>
                <p class="stat-description">All time platform revenue</p>
            </div>
            <div class="stat-card">
                <h3>Platform Fees</h3>
                <p class="stat-value" id="platform-fees">₹0</p>
                <p class="stat-description">Commission from orders</p>
            </div>
            <div class="stat-card">
                <h3>Shipping Fees</h3>
                <p class="stat-value" id="shipping-fees">₹0</p>
                <p class="stat-description">Delivery charges collected</p>
            </div>
            <div class="stat-card">
                <h3>Credit Revenue</h3>
                <p class="stat-value" id="credit-revenue">₹0</p>
                <p class="stat-description">Revenue from credit sales</p>
            </div>
            <div class="stat-card">
                <h3>Orders Processed</h3>
                <p class="stat-value" id="total-orders">0</p>
                <p class="stat-description">Total orders handled</p>
            </div>
            <div class="stat-card">
                <h3>Credits Sold</h3>
                <p class="stat-value" id="credits-sold">0</p>
                <p class="stat-description">Total credits purchased by sellers</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>Revenue Breakdown</h3>
                <canvas id="revenue-chart" width="400" height="200"></canvas>
            </div>
            <div class="chart-card">
                <h3>Monthly Trends</h3>
                <canvas id="trend-chart" width="300" height="200"></canvas>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3>Transaction History Filters</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label>Transaction Type</label>
                    <select id="transaction-type-filter">
                        <option value="">All Types</option>
                        <option value="platform_fee">Platform Fee</option>
                        <option value="shipping_fee">Shipping Fee</option>
                        <option value="tax_amount">Tax Amount</option>
                        <option value="credit_purchase">Credit Purchase</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="date-from">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="date-to">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <a href="#" class="btn btn-secondary" onclick="downloadReport()">Download Report</a>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions-table">
            <h3>Recent Transactions</h3>
            <div id="transactions-list">
                <!-- Transactions will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentData = {};
let revenueChart = null;
let trendChart = null;

// Load dashboard data
async function loadDashboard() {
    try {
        const token = getAuthToken();
        if (!token) {
            showError('Authentication required. Please login to admin panel.');
            return;
        }

        // Load statistics
        const statsResponse = await fetch('/api/payments/admin/dashboard/stats/', {
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!statsResponse.ok) {
            throw new Error(`Stats API Error: ${statsResponse.status}`);
        }

        const stats = await statsResponse.json();
        updateStatistics(stats);

        // Load recent transactions
        const historyResponse = await fetch('/api/payments/admin/wallet/history/?limit=10', {
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (historyResponse.ok) {
            const history = await historyResponse.json();
            updateTransactionsList(history.results || history);
        }

        // Create charts
        createCharts(stats);

        // Hide loading and show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';

    } catch (error) {
        console.error('Dashboard loading error:', error);
        showError(`Failed to load dashboard: ${error.message}`);
        document.getElementById('loading').style.display = 'none';
    }
}

// Update statistics display
function updateStatistics(stats) {
    currentData = stats;
    
    document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue || 0);
    document.getElementById('platform-fees').textContent = formatCurrency(stats.platform_fees || 0);
    document.getElementById('shipping-fees').textContent = formatCurrency(stats.shipping_fees || 0);
    document.getElementById('credit-revenue').textContent = formatCurrency(stats.credit_revenue || 0);
    document.getElementById('total-orders').textContent = stats.total_orders || 0;
    document.getElementById('credits-sold').textContent = stats.total_credits_sold || 0;
}

// Update transactions list
function updateTransactionsList(transactions) {
    const container = document.getElementById('transactions-list');
    
    if (!transactions || transactions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No transactions found</p>';
        return;
    }

    container.innerHTML = transactions.map(transaction => `
        <div class="transaction-item">
            <div class="transaction-info">
                <div class="transaction-type">${formatTransactionType(transaction.transaction_type)}</div>
                <div class="transaction-desc">${transaction.description}</div>
                ${transaction.reference_id ? `<div class="transaction-desc">Ref: ${transaction.reference_id}</div>` : ''}
            </div>
            <div style="text-align: right;">
                <div class="transaction-amount">₹${transaction.amount}</div>
                <div class="transaction-date">${formatDate(transaction.created_at)}</div>
            </div>
        </div>
    `).join('');
}

// Create charts
function createCharts(stats) {
    // Revenue Breakdown Chart
    const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
    
    if (revenueChart) {
        revenueChart.destroy();
    }
    
    revenueChart = new Chart(revenueCtx, {
        type: 'doughnut',
        data: {
            labels: ['Platform Fees', 'Shipping Fees', 'Tax Amount', 'Credit Revenue'],
            datasets: [{
                data: [
                    stats.platform_fees || 0,
                    stats.shipping_fees || 0,
                    stats.tax_amount || 0,
                    stats.credit_revenue || 0
                ],
                backgroundColor: [
                    '#007cba',
                    '#28a745',
                    '#ffc107',
                    '#17a2b8'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Monthly Trend Chart (placeholder data)
    const trendCtx = document.getElementById('trend-chart').getContext('2d');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    trendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: ['This Month', 'Today'],
            datasets: [{
                label: 'Revenue',
                data: [stats.this_month_revenue || 0, stats.today_revenue || 0],
                backgroundColor: '#007cba'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Apply filters to transaction history
async function applyFilters() {
    try {
        const token = getAuthToken();
        const transactionType = document.getElementById('transaction-type-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        let url = '/api/payments/admin/wallet/history/?';
        const params = new URLSearchParams();

        if (transactionType) params.append('transaction_type', transactionType);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);

        url += params.toString();

        const response = await fetch(url, {
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const history = await response.json();
            updateTransactionsList(history.results || history);
        } else {
            showError('Failed to filter transactions');
        }
    } catch (error) {
        showError(`Filter error: ${error.message}`);
    }
}

// Download revenue report
async function downloadReport() {
    try {
        const token = getAuthToken();
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        const reportData = {
            report_type: 'detailed'
        };

        if (dateFrom) reportData.date_from = dateFrom;
        if (dateTo) reportData.date_to = dateTo;

        const response = await fetch('/api/payments/admin/revenue/report/', {
            method: 'POST',
            headers: {
                'Authorization': `Token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(reportData)
        });

        if (response.ok) {
            // Download the PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-revenue-report-${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            showError('Failed to download report');
        }
    } catch (error) {
        showError(`Download error: ${error.message}`);
    }
}

// Utility functions
function getAuthToken() {
    // Try to get token from Django admin session or localStorage
    return localStorage.getItem('authToken') || getCookie('authtoken') || '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatCurrency(amount) {
    return `₹${Number(amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
}

function formatTransactionType(type) {
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showError(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `<div class="error">${message}</div>`;
}

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', loadDashboard);

// Auto-refresh every 5 minutes
setInterval(loadDashboard, 5 * 60 * 1000);
</script>
{% endblock %}
